<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>NHL Goalies</title>
		<style>
		h2{
			font-family:"sans-serif";
			position: absolute;
			top: 10px;
			left: 336px;
		}
		#intro {
		  font-family:"sans-serif";
		  font-size: 14px;
		  position: absolute;
		  top: 58px;
		  left: 100px;
		  width: 700px;
		  height: 95px;
		  text-align: center;
		}
		</style>
		<link rel="stylesheet" type="text/css" href="tipsy.css">
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
		<script type="text/javascript" src="jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="jquery.tipsy.js"></script>
	</head>		
    <body>
    <h2>Charting NHL Goalies</h2>
    <div id ="intro">
    </br>
    Inspired by graphics at the <a href = "http://www.nytimes.com/newsgraphics/2013/09/28/eli-manning-milestone/">New York Times<a> and <a href= "http://regressing.deadspin.com/which-nfl-teams-have-started-the-most-quarterbacks-199-1467826931">Deadspin</a>, this chart displays the number of games each goalie played for all NHL teams from 2000-2013. Goalies are only included if they played more than 5 games for that team. The tams are ordered by the number of different goalies who have played for them during this period. Note that each team has not played the same number of games during this time period, since the data include playoff games. Data from Hockey Reference. 
    </div>
	<script type= "text/javascript">
	 var w = 1100;
	 var h = 600;
	 var barw = 800;
   //define svg function
     var svg = d3.select("body")
         .append("svg")
         .attr("width", w)
         .attr("height", h+200);    
        // load data
 d3.json("nhl.json", function(error, data) {
	if (error) {  //If error is not null, something went wrong.
       console.log(error);  
	}
	else {
	// declare variables		
	   var ndata = data;
	   var gdata;
	   var stdata = [];
	   var maxlength = 0;
	   var maxteam = "";
	   // sort teams in ascending order of # of goalies
	   var sortteams = ndata.sort(function(a,b){ 
    var x = a.goalies.length < b.goalies.length? -1:1; 
    return x; 
    });
    //define y scale
    var yScale = d3.scale.ordinal()
                         .domain(d3.range(ndata.length))
                         .rangeRoundBands([150,h+150], .15);                                           
	//    
	// key fns
	var team = function(d) {
	   return d.team;
	};
	
	var goalies = function(d) {
		return d.goalies;
	};
	var player = function(d) {
	    return d.player;
	};
	// add team text
	svg.selectAll("text")
	   .data(ndata, team)
	   .enter()
	   .append("text")
	   .attr("x", 860)
	   .attr("font-family","sans-serif")
	   .attr("font-size","11px")
	   .attr("y", function(d,i) {
	   	   return yScale(i) + (yScale.rangeBand() /2) + 3; 
	   })
	   .text(function(d) {
	   	return d.team
	   }); 
	// data bind + rectangles
	for (i = 0; i< ndata.length; i ++){
		gdata = sortteams[i].goalies.sort(function(a,b){ 
    var x = a.gp > b.gp? -1:1; 
    return x; 
    });
    // fix y pos
		var fixy = yScale(i);
		
	    var gmax = 0;
		stdata = [];
		//
		for (j = 0; j < gdata.length; j++){
			// determine total number of games
		    gmax = gmax + gdata[j].gp	
		    // give data x, y vals
		    xval = j;
		    yval = gdata[j].gp;
		    nname = gdata[j].player;
		    stdata.push([{"x": xval,"y": yval, "name":nname}]);
		}
		// scale determining bar width
		var wScale = d3.scale.linear()
		                     .domain([0,gmax])
		                     .range([0, barw]);                        
        //stack players within team
        var stack = d3.layout.stack();
        stack(stdata);                                           		                                      
		//class label for rectangles belonging to team
		var classlbl = ".b" + [i]
		
		// 
		var groups = svg.selectAll(classlbl)
                        .data(stdata)
                        .enter()
                        .append("g")	
		// add rectangles
 var rect = groups.selectAll("rect")
	           .data(function(d) {return d;})
	           .enter()
	           .append("rect")
	           .attr("pid", function(d) {
	           	    return d.name
	           })
	           .attr("gpid", function(d) {
	           	    return d.y
	           })
	           .attr("x", function(d) {
	   	           return wScale(d.y0) + 50;
	           })
	           .attr("y", fixy)
	           .attr("width", function(d) {
	   	          return wScale(d.y);
	           })
	           .attr("height", yScale.rangeBand())
	           .attr("fill","dodgerblue")
	           .attr("stroke","black")
	           // mouseover
	           .on("mouseover", function(d,i) {
	             // change color
	           	d3.select(this)
	           	  .attr("fill","orange");
	           	//add label
	           })
	           // mouseout
	           .on("mouseout", function(d,i) {
	           	d3.select(this)
	           	  .transition()
	           	  .duration(250)
	           	  .attr("fill","dodgerblue");
	           });
	           
	   ///
	 /// tooltips          
$("rect").tipsy({
	delayIn:250,
	delayOut: 250,
	gravity: function() {
		if(this.getAttribute("y") <= 300+150) {
			if(this.getAttribute("x") <= 550) {
				return 'nw';
			} else {
			    return 'ne';
			}
		} else {
			if (this.getAttribute("x") <= 550) {
				return 'sw';
			} else {
			    return 'se';
			}
		}
		
	},
	offset: 10, 
	title: function() {
		return this.getAttribute("pid") + ": " + this.getAttribute("gpid") + " Games";
    }
	});	
	} 
	}
 });
      </script>	
	</body>
</html>    